# Гайд миграции тестового API

- [Мотивация](#Мотивация)
- [Что изменилось?](#Что-изменилось?)
- [Добавление алиаса для пакета `config`](#Добавление-алиаса-для-пакета-config)
- [Изменение сборки tsconfig](#Изменение-сборки-tsconfig)
- [Изменение импорта TS модулей в JS файлах](#Изменение-импорта-TS-модулей-в-JS-файлах)
- [Замена Jasmine API на PW API](#Замена-Jasmine-API-на-PW-API)
- [Сборка при запуске тестов](#Сборка-при-запуске-тестов)
- [Запуск тестового сервера](#Запуск-тестового-сервера)
- [Запуск тестов](#Запуск-тестов)
- [Изоляция спек](#изоляция-спек)
- [Изменение API хелперов для тестов](#изменение-api-хелперов-для-тестов)
  - [static методы](#Static-методы)
  - [Новое API `Component.createComponent`](#новое-api-componentcreatecomponent)
- [QA](https://github.com/V4Fire/Client/blob/master/docs/tests/migration/ru/qa.md)

## Мотивация

Основные цели которые были поставлены при переезде на новое API были таковы:

1. Иметь возможность писать тесты на `Typescript`, улучшить опыт написания тестов;
2. Ускорить выполнение (за счет лучшей параллелизации) тестов, увеличить их стабильность.

## Что изменилось?

Наше старое API для тестов объявляется `deprecated`, это означает что в скором времени поддержка старого API перестанет осуществляться, так же это значит что старое API переводится в режим "без улучшений", в случае возникновения ошибок они будут исправлены, но улучшения производится не будут.

Старое API заменено на `@playwright/test`, документация: https://playwright.dev/

## Миграция

### Добавление алиаса для пакета `config`

Так как для тестов используется `typescript` то импорт пакета `config` приводит к неправильному резолвингу и
вместо ожидаемого импорта пакета - импортится файл `src/config/index.ts`.

Чтобы этого избежать необходимо добавить алиасинг к пакету `config` в `package.json`.

```
"@config/config": "npm:config@1.31.0"
```

После этого все импорты пакета `config` (они обычно в JS файлах `require`) нужно заменить на `@config/config`.

### Изменение сборки tsconfig

Генерация `tsconfig` вынесена в standalone скрипт, то есть он больше не является gulp задачей, при этом стоит отметить, что в `tsconfig` будут добавлены новые алиасы для путей, `build`, `tests`.

Чтобы сгенерировать `tsconfig` следует запустить файл `@v4fire/core/build/tsconfig` с помощью `node`. Для простоты использования можно создать алиас в `package.json`.

```
"scripts": {
  "build:tsconfig": "node node_modules/@v4fire/core/build/tsconfig"
}
```
### Изменение импорта TS модулей в JS файлах

```js
const
  h = include('tests/helpers');
```

->

```js
const
  h = include('tests/helpers').default;
```

### Замена Jasmine API на PW API

Функция `expect` и прочие теперь не определены глобально, их необходимо импортировать

```typescript
import test from 'tests/config/unit/test';

test.describe('test', () => {});
```

Путь импорта для `unit` и для проектных тестов может отличаться, так например для каждого вида тестов (проектов) следует
иметь свой экземпляр тестов, это необходимо чтобы расширить возможности тестового API с помощью fixture.

```
expect -> test.expect
describe -> test.describe
etc
```

### Сборка при запуске тестов

Если раньше при запуске тестов проект собирался тоже, то теперь, перед тем как запустить тесты необходимо собрать проект. Делается это точно так же как и в любой другой ситуации, с помощью команды `npx webpack`.

### Запуск тестового сервера

Для запуска тестового сервера по умолчанию исполняется npm команда `npm run test:server`, но это можно изменить в конфигурационном файле. V4Fire по умолчанию предоставляет API тестового сервера.

Если вы в дочернем проекте добавляете функциональность unit тестирования компонентов, необходимо добавить команду для запуска тестового сервера в `package.json` или переопределить через конфиг на необходимую вам.

__tests/server/index.ts__
```typescript
import '@v4fire/client/tests/server';
```

__package.json__
```
  "scripts": {
    "test:server": "cross-env NODE_OPTIONS=\"-r @v4fire/core/build/tsnode.js\" node tests/server",
  }
```

### Запуск тестов

Первое что необходимо сделать это скомпилировать проект, делается это с помощью `npx webpack`. Можно так же установить флаг `--watch` и запустить тесты в отдельном окне.

Для запуска тестов на TS необходимо подключить `tsnode.js` из `@v4fire/core` в среду исполнения. Самое удобное место для этого - npm scripts. Можно сделать следующим образом:

__package.json__
```
"scripts": {
  "test:unit": "cross-env NODE_OPTIONS=\"-r @v4fire/core/build/tsnode.js\" npx playwright test --config tests/config/unit"
}
```

Так же необходимо указать `playwright` путь до конфига, v4 предоставляет 2 конфига по умолчанию, но вы можете добавлять их сколько вам угодно. Подробнее про конфиги можно ознакомится в секции "Конфигурационный файл".

### Изоляция спек

Теперь каждая спека запускается на отдельной страницы и с отдельным контекстом **автоматически**. Это поведение можно обойти, но делать это крайне не рекомендуется.

### Изменение API хелперов для тестов

#### Static методы

Так же хэлперы для тестов претерпели и продолжат немного менять свое API, так теперь все методы будут `static`! а общий модуль который аккумулирует хэлперы будет удален. На данном этапе большая часть методов стала `static` методами, но для обратной совместимости методы экземпляра временно остаются.

Раньше было так:

```typescript
import h from 'tests/helpers';

h.router.something();
```

Теперь будет так:

```typescript
import Router from 'tests/helpers/router'

Router.something();
```

#### Новое API `Component.createComponent`

Раньше для создания компонента мы обращались к экземпляру `page`, вызывали метод `evaluate` и внутри контекста создавали
компонент с помощью `globalThis.renderComponents` это подход имел много очень серьезных недостатков и неудобств, а именно:

1. Ссылка на компонент не возвращалась. Чтобы получить ссылку на компонент приходилось делать дополнительные вызовы;
2. Невозможность работы с функциями. Метод `page.evaluate` не может прокидывать внутрь страницы функции, из-за этого приходилось делать странные вещи по месту руками;
3. Громоздкость записи в связи с пунктами выше.

Для решениях всех этих проблем в был создан метод `Component.createComponent` который инкапсулирует в себя решения всех этих проблем.

```typescript
const
	bDummy = await Component.createComponent<bDummy>(page, 'b-dummy', {attrs: {someFnProp: () => console.log(1)}});
```

В данном примере `bDummy` будет иметь тип `JSHandle<bDummy>`.

## QA

https://github.com/V4Fire/Client/blob/master/docs/tests/migration/ru/qa.md